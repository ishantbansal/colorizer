{"changed":true,"filter":false,"title":"colorize.lua","tooltip":"/colorize.lua","value":"--[[\n   Copyright (C) <2016> <Satoshi Iizuka, Edgar Simo-Serra, Hiroshi Ishikawa>\n\n   This work is licensed under the Creative Commons\n   Attribution-NonCommercial-ShareAlike 4.0 International License. To view a copy\n   of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/ or\n   send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.\n\n   Satoshi Iizuka, Waseda University\n   iizuka@aoni.waseda.jp, http://hi.cs.waseda.ac.jp/~iizuka/\n   Edgar Simo-Serra, Waseda University\n   esimo@aoni.waseda.jp, http://hi.cs.waseda.ac.jp/~esimo/\n--]]\n\n\nrequire 'nn'\nrequire 'nngraph'\nrequire 'image'\n\nlocal infile  = arg[1]\nlocal outfile = arg[2] or 'out.png'\nlocal netfile = arg[3] or 'colornet.t7'\n\nlocal d        = torch.load( netfile )\nlocal datamean = d.mean\nlocal model    = d.model:float()\n\nlocal function pred2rgb( x, data )\n   local I = torch.cat( data[1][{{1},{},{}}]:float(),\n                        data[1]:clone():float():mul(2):add(-1), 1)\n   local O = image.scale( I, x:size(3), x:size(2) )\n   local X = image.rgb2lab( image.yuv2rgb( torch.repeatTensor( x, 3, 1, 1 ) ) )\n   O    = O*100\n   O[1] = X[1]\n   O    = image.rgb2yuv( image.lab2rgb( O ) )\n   return image.yuv2rgb( torch.cat( x, O[{{2,3},{},{}}], 1 ) )\nend\nze.load( infile )\nif I:size(1)==3 then I = image.rgb2y(I) end\nlocal X2 = image.scale( I, torch.round(I:size(3)/8)*8, torch.round(I:size(2)/8)*8 ):add(-datamean):float()\nlocal X1 = image.scale( X2, 224, 224 ):float()\nX1 = X1:reshape( 1, X1:size(1), X1:size(2), X1:size(3) )\nX2 = X2:reshape( 1, X2:size(1), X2:size(2), X2:size(3) )\nmodel.forwardnodes[9].data.module.modules[3].nfeatures = X2:size(3)/8\nmodel.forwardnodes[9].data.module.modules[4].nfeatures = X2:size(4)/8\n\nimage.save( outfile, pred2rgb( I:float(), model:forward( {X1, X2} ) ) )\n\n\n\n","undoManager":{"mark":-2,"position":0,"stack":[[{"start":{"row":37,"column":0},"end":{"row":38,"column":14},"action":"remove","lines":["","local I = imag"],"id":2},{"start":{"row":37,"column":0},"end":{"row":37,"column":1},"action":"insert","lines":["z"]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":17,"column":15},"end":{"row":17,"column":15},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1516357268000}